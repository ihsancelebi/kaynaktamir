<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="pageTitle">Kaynak Sa√ß Tamir Takip</title>
    <link rel="apple-touch-icon" href="iconios.png">
    <link rel="icon" href="iconios.png" type="image/png">
    <link rel="shortcut icon" href="/favicon.ico">
    <style>
        /* General styling for the entire page */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        /* Loading overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            flex-direction: column;
            color: #555;
            font-size: 1.2em;
        }

        /* Container for the main application content */
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
            display: none; /* Initially hidden */
        }

        /* Header section styling */
        .header {
            background: linear-gradient(45deg, #ff6b6b, #ffa500);
            color: white;
            padding: 20px 30px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        
        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            position: relative;
            z-index: 2;
        }

        .user-info {
            font-size: 12px;
            text-align: left;
        }

        .user-info span {
            display: block;
            max-width: 150px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .auth-actions button, .auth-actions a {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            padding: 5px 10px;
            border-radius: 10px;
            font-size: 12px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            margin-left: 5px;
            transition: background 0.3s ease;
        }
        
        .auth-actions button:hover, .auth-actions a:hover {
             background: rgba(255,255,255,0.4);
        }

        .header h1 {
            position: relative;
            z-index: 1;
            font-size: 2.2em;
            margin-bottom: 5px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            position: relative;
            z-index: 1;
            opacity: 0.9;
            font-size: 1em;
        }
        
        #app-logo {
            width: 200px; 
            height: 60px;  
            margin-bottom: 10px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            position: relative;
            z-index: 1;
            display: inline-block; 
            -webkit-mask-image: url(logo.svg);
            mask-image: url(logo.svg);
            -webkit-mask-size: contain; 
            mask-size: contain;
            -webkit-mask-repeat: no-repeat;
            mask-repeat: no-repeat;
            -webkit-mask-position: center;
            mask-position: center;
        }
        
        .connection-status {
            position: absolute;
            bottom: 10px;
            right: 15px;
            background: rgba(255,255,255,0.2);
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            z-index: 2;
        }

        .status-online { color: #28a745; }
        .status-offline { color: #dc3545; }

        /* Navigation bar styling */
        .nav {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }

        .nav-btn {
            flex: 1;
            padding: 15px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            color: #6c757d;
            transition: all 0.3s ease;
            position: relative;
        }

        .nav-btn.active {
            color: #007bff;
            background: white;
        }

        .nav-btn.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(45deg, #007bff, #0056b3);
        }
        
        /* General Styling... (Copied from original, no changes needed for most parts) */
        .content { padding: 30px; }
        .section { display: none; }
        .section.active { display: block; animation: fadeIn 0.5s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .form-group { margin-bottom: 25px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #333; font-size: 14px; text-transform: uppercase; }
        .form-group input, .form-group textarea { width: 100%; padding: 15px; border: 2px solid #e9ecef; border-radius: 10px; font-size: 16px; transition: all 0.3s ease; background: #f8f9fa; }
        .form-group textarea { min-height: 100px; resize: vertical; }
        .form-group input:focus, .form-group textarea:focus { outline: none; border-color: #007bff; background: white; box-shadow: 0 0 0 3px rgba(0,123,255,0.1); }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .radio-group-vertical label { display: flex; align-items: center; gap: 8px; font-weight: normal; text-transform: none; margin-bottom: 10px; width: fit-content; }
        .radio-group-vertical input[type="radio"] { width: auto; margin-right: 5px; }
        .photo-upload { border: 3px dashed #dee2e6; border-radius: 15px; padding: 30px; text-align: center; background: #f8f9fa; cursor: pointer; }
        .photo-preview { max-width: 200px; max-height: 200px; border-radius: 10px; margin: 10px auto; display: block; object-fit: cover; }
        .btn { background: linear-gradient(45deg, #007bff, #0056b3); color: white; border: none; padding: 15px 30px; border-radius: 25px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }
        .btn:hover:not(:disabled) { transform: translateY(-3px); box-shadow: 0 10px 25px rgba(0,123,255,0.3); }
        .loading { display: inline-block; width: 20px; height: 20px; border: 2px solid #ffffff40; border-radius: 50%; border-top-color: #ffffff; animation: spin 1s ease-in-out infinite; margin-right: 10px; vertical-align: middle; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .record-card { background: white; border: 1px solid #e9ecef; border-radius: 15px; padding: 25px; margin-bottom: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.08); transition: all 0.3s ease; position: relative; cursor: pointer; }
        .record-card:hover { transform: translateY(-5px); box-shadow: 0 15px 30px rgba(0,0,0,0.15); }
        .record-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 15px; border-bottom: 2px solid #f8f9fa; }
        .record-name { font-size: 1.4em; font-weight: 700; color: #333; }
        .record-details-always-visible { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 15px; }
        .record-detail { display: flex; align-items: center; gap: 10px; }
        .record-detail-icon { width: 40px; height: 40px; background: linear-gradient(45deg, #007bff, #0056b3); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 18px; flex-shrink: 0; }
        .record-detail-text span { display: block; }
        .record-detail-label { font-size: 12px; color: #6c757d; }
        .record-detail-value { font-weight: 600; color: #333; }
        .record-collapsible-content { max-height: 0; overflow: hidden; transition: max-height 0.4s ease-out; }
        .record-card.expanded .record-collapsible-content { max-height: 1800px; padding-top: 15px; }
        .expand-icon { font-size: 1.2em; transition: transform 0.3s ease; }
        .record-card.expanded .expand-icon { transform: rotate(180deg); }
        .record-actions { text-align: right; margin-top: 15px; display: none; }
        .record-card.expanded .record-actions { display: block; }
        .delete-btn { background: #dc3545; color: white; border: none; padding: 8px 15px; border-radius: 15px; font-size: 12px; cursor: pointer; }
        .empty-state { text-align: center; padding: 60px 20px; color: #6c757d; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); align-items: center; justify-content: center; }
        .modal-content img { max-width: 90%; max-height: 90%; border-radius: 10px; }
        .close-modal { position: absolute; top: 20px; right: 30px; color: white; font-size: 40px; cursor: pointer; }
        .success-message, .error-message { padding: 15px; border-radius: 10px; margin-bottom: 20px; text-align: center; font-weight: 600; position: fixed; top: -100px; left: 50%; transform: translateX(-50%); z-index: 2000; min-width: 300px; opacity: 0; transition: top 0.5s ease, opacity 0.5s ease; }
        .success-message { background: linear-gradient(45deg, #28a745, #20c997); color: white; }
        .error-message { background: linear-gradient(45deg, #dc3545, #c82333); color: white; }
        .filter-controls { margin-bottom: 20px; border: 1px solid #e9ecef; border-radius: 10px; background: #f8f9fa; }
        .filter-header { display: flex; justify-content: space-between; align-items: center; padding: 15px; cursor: pointer; font-weight: 600; }
        .filter-collapsible-content { max-height: 0; padding: 0 15px; overflow: hidden; transition: max-height 0.4s ease-out, padding 0.4s ease-out; }
        .filter-collapsible-content.expanded { max-height: 300px; padding: 15px; }
        .creator-info { font-size: 11px; color: #6c757d; margin-top: 10px; padding-top: 10px; border-top: 1px solid #f0f0f0; }

        @media (max-width: 768px) {
            .form-row { grid-template-columns: 1fr; }
            .header-top { flex-direction: column; align-items: flex-start; gap: 10px; }
            .user-info { text-align: left; }
            .auth-actions { align-self: flex-start; }
            #app-logo { width: 180px; height: 50px; }
        }
    </style>
</head>
<body>

    <!-- Y√ºkleniyor Ekranƒ± -->
    <div id="loading-overlay" class="loading-overlay">
        <div class="loading" style="width: 50px; height: 50px; border-width: 5px; border-top-color: #764ba2;"></div>
        <p style="margin-top: 20px;">Oturum kontrol ediliyor...</p>
    </div>

    <div class="container" id="main-container">
        <div class="header">
            <div class="header-top">
                <div class="user-info" id="user-info-display">
                    <!-- Kullanƒ±cƒ± bilgisi buraya gelecek -->
                </div>
                <div class="auth-actions">
                    <a href="tamir.html">Tamir Sayfasƒ±</a>
                    <button onclick="logout()">√áƒ±kƒ±≈ü Yap</button>
                </div>
            </div>
            
            <div id="app-logo" title="Hair Extension Repair Tracking Logo"></div>
            <p data-translate="headerSubtitle">Bulut destekli profesyonel tamir takip sistemi</p>
            
            <div class="connection-status" id="connection-status">
                <span id="status-text" data-translate="connecting">üîÑ Baƒülanƒ±yor...</span>
            </div>
        </div>
        
        <div class="nav">
            <button class="nav-btn active" onclick="showSection('add')" data-translate="navNewRecord">‚ûï Yeni Kayƒ±t</button>
            <button class="nav-btn" onclick="showSection('list')" data-translate="navRecords">üìã Kayƒ±tlar</button>
        </div>
        
        <div class="content">
            <div id="add-section" class="section active">
                <form id="repair-form">
                    <!-- Form i√ßeriƒüi deƒüi≈ümedi, aynƒ± kalabilir -->
                    <div class="form-row">
                        <div class="form-group">
                            <label data-translate="formFirstName">ƒ∞sim</label>
                            <input type="text" id="firstName" required>
                        </div>
                        <div class="form-group">
                            <label data-translate="formLastName">Soyisim</label>
                            <input type="text" id="lastName" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label data-translate="formPhone">Telefon</label>
                        <input type="tel" id="phone" required placeholder="+90 5XX XXX XX XX">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Tamire Verilen Tarih</label> <input type="date" id="repairDate" required>
                        </div>
                        <div class="form-group">
                            <label>Termin Tarihi</label>  <input type="date" id="returnDate" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Kaynak Adedi</label>
                            <input type="number" id="quantity" min="1" required>
                        </div>
                        <div class="form-group">
                            <label>Adet Tamir Fiyatƒ± (‚Ç∫)</label>
                            <input type="number" id="unitPrice" min="0" step="0.01" value="10" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Takƒ±m Olacak mƒ±?</label>
                        <div class="radio-group-vertical" style="margin-top: 10px;">
                            <label><input type="radio" name="hasSet" value="evet" required> Evet</label>
                            <label><input type="radio" name="hasSet" value="hayƒ±r" required> Hayƒ±r</label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Notlar</label>
                        <textarea id="notes" rows="4"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Fotoƒüraf</label>
                        <div class="photo-upload" onclick="document.getElementById('photoInput').click()">
                            <input type="file" id="photoInput" accept="image/*" style="display: none;">
                            <div id="photo-placeholder">üì∑<br><strong>Fotoƒüraf Ekle</strong></div>
                            <img id="photo-preview-img" class="photo-preview" style="display:none;">
                        </div>
                    </div>
                    <button type="submit" class="btn" id="submit-btn">
                        <span id="submit-text">‚ûï Ekle</span>
                    </button>
                </form>
            </div>
            
            <div id="list-section" class="section">
                <!-- Filtreleme ve liste i√ßeriƒüi deƒüi≈ümedi -->
                 <div class="filter-controls">
                    <div class="filter-header" onclick="toggleFilterControls()">
                        <span>Filtreleme Se√ßenekleri</span>
                        <span class="expand-icon">üîç</span>
                    </div>
                    <div id="filter-collapsible-content" class="filter-collapsible-content">
                        <div class="form-row" style="margin-bottom: 15px;">
                            <div class="form-group" style="margin-bottom: 0;">
                                <label for="startDateFilter">Ba≈ülangƒ±√ß Tarihi</label>
                                <input type="date" id="startDateFilter">
                            </div>
                            <div class="form-group" style="margin-bottom: 0;">
                                <label for="endDateFilter">Biti≈ü Tarihi</label>
                                <input type="date" id="endDateFilter">
                            </div>
                        </div>
                        <div class="form-group" style="margin-bottom: 15px;">
                            <label for="searchFilter">ƒ∞sim veya Telefon Ara</label>
                            <input type="text" id="searchFilter" placeholder="ƒ∞sim veya telefon...">
                        </div>
                        <button class="btn" onclick="applyFilters()" style="width: 100%;">Filtrele</button>
                    </div>
                </div>
                <div id="records-container"></div>
            </div>
        </div>
    </div>
    
    <div id="photo-modal" class="modal">
        <span class="close-modal" onclick="closePhotoModal()">&times;</span>
        <div class="modal-content"><img id="modal-image" src=""></div>
    </div>

    <!-- Firebase SDK'larƒ± -->
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
    
    <script>
        // Global variables
        let db = null;
        let auth = null;
        let currentUser = null;
        let records = []; 
        let currentPhotoFile = null; 
        let isFirebaseInitialized = false;

        // --- Firebase Projesi Yapƒ±landƒ±rma Detaylarƒ± ---
        const firebaseConfig = {
             apiKey: "AIzaSyCsy1AAiRE8HCCt4HEAcz7Sh9AM6sQt4FQ", 
             authDomain: "kaynak-sac-tamir.firebaseapp.com",
             projectId: "kaynak-sac-tamir",
             messagingSenderId: "503655162792",
             appId: "1:503655162792:web:faad92041850490b92f39d",
             measurementId: "G-N8B2V6RQET" 
        };

        // --- Imgur ƒ∞stemci Kimliƒüiniz ---
        const IMGUR_CLIENT_ID = '82ab37b38a1850a'; 

        // Sayfa y√ºklendiƒüinde √ßalƒ±≈üacak ana fonksiyon
        document.addEventListener('DOMContentLoaded', function() {
            try {
                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                }
                auth = firebase.auth();
                db = firebase.firestore();
                isFirebaseInitialized = true;

                // Oturum durumunu dinle
                auth.onAuthStateChanged(user => {
                    const loadingOverlay = document.getElementById('loading-overlay');
                    const mainContainer = document.getElementById('main-container');
                    
                    if (user) {
                        // Kullanƒ±cƒ± giri≈ü yapmƒ±≈ü
                        currentUser = user;
                        loadingOverlay.style.display = 'none';
                        mainContainer.style.display = 'block';
                        initializeApp();
                    } else {
                        // Kullanƒ±cƒ± giri≈ü yapmamƒ±≈ü, login sayfasƒ±na y√∂nlendir
                        window.location.href = 'login.html';
                    }
                });
            } catch (error) {
                console.error("Firebase ba≈ülatma hatasƒ±:", error);
                document.getElementById('loading-overlay').innerHTML = 'Hata: Uygulama ba≈ülatƒ±lamadƒ±. L√ºtfen sayfayƒ± yenileyin.';
            }
        });

        // Uygulamayƒ± ba≈ülatan fonksiyon (giri≈ü yapƒ±ldƒ±ktan sonra)
        function initializeApp() {
            document.getElementById('user-info-display').innerHTML = `<span>Ho≈ü geldin, <strong>${currentUser.email}</strong></span>`;
            document.getElementById('status-text').textContent = '‚úîÔ∏è Baƒülandƒ±';
            document.getElementById('connection-status').classList.add('status-online');
            
            document.getElementById('repairDate').valueAsDate = new Date();
            document.getElementById('unitPrice').value = '10';

            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.addEventListener('click', (event) => {
                    document.querySelector('.nav-btn.active')?.classList.remove('active');
                    event.currentTarget.classList.add('active');
                });
            });

            document.getElementById('repair-form').addEventListener('submit', handleFormSubmit);
            document.getElementById('photoInput').addEventListener('change', handlePhotoInputChange);
            
            showSection('add');
        }

        // √áƒ±kƒ±≈ü yapma fonksiyonu
        function logout() {
            auth.signOut().then(() => {
                // onAuthStateChanged y√∂nlendirmeyi yapacak
                console.log('√áƒ±kƒ±≈ü yapƒ±ldƒ±');
            }).catch(error => {
                console.error('√áƒ±kƒ±≈ü yaparken hata olu≈ütu', error);
                showMessage('√áƒ±kƒ±≈ü yapƒ±lamadƒ±.', 'error');
            });
        }

        // --- Mevcut Fonksiyonlar (Authentication ile g√ºncellendi) ---

        async function handleFormSubmit(event) {
            event.preventDefault();
            if (!isFirebaseInitialized || !currentUser) {
                showMessage('L√ºtfen √∂nce giri≈ü yapƒ±n.', 'error');
                return;
            }

            const submitBtn = document.getElementById('submit-btn');
            const submitText = document.getElementById('submit-text');
            submitBtn.disabled = true;
            submitText.innerHTML = `<div class="loading"></div> Ekleniyor...`;

            const record = {
                firstName: document.getElementById('firstName').value.trim(),
                lastName: document.getElementById('lastName').value.trim(),
                phone: document.getElementById('phone').value.trim(),
                repairDate: document.getElementById('repairDate').value,
                returnDate: document.getElementById('returnDate').value,
                quantity: parseInt(document.getElementById('quantity').value),
                unitPrice: parseFloat(document.getElementById('unitPrice').value),
                totalPrice: parseInt(document.getElementById('quantity').value) * parseFloat(document.getElementById('unitPrice').value),
                hasSet: document.querySelector('input[name="hasSet"]:checked').value,
                notes: document.getElementById('notes').value.trim(),
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                // Kaydƒ± olu≈üturan kullanƒ±cƒ± bilgisi
                createdBy: {
                    uid: currentUser.uid,
                    email: currentUser.email
                },
                // Tamamlanma bilgileri
                status: 'pending',
                completedQuantity: null,
                completionDate: null,
                completionNotes: null,
                completedPhotoURL: null,
                completedBy: null
            };

            try {
                if (currentPhotoFile) {
                    submitText.innerHTML = `<div class="loading"></div> Fotoƒüraf y√ºkleniyor...`;
                    record.photoURL = await uploadPhotoToImgur(currentPhotoFile);
                }
                
                submitText.innerHTML = `<div class="loading"></div> Kayƒ±t ekleniyor...`;
                await db.collection('repairs').add(record);
                
                showMessage('Kayƒ±t ba≈üarƒ±yla eklendi!', 'success');
                document.getElementById('repair-form').reset();
                document.getElementById('repairDate').valueAsDate = new Date();
                document.getElementById('unitPrice').value = '10';
                currentPhotoFile = null;
                document.getElementById('photo-preview-img').style.display = 'none';
                document.getElementById('photo-placeholder').style.display = 'block';
                showSection('list');

            } catch (error) {
                console.error("ƒ∞≈ülem hatasƒ±:", error);
                showMessage(`Kayƒ±t eklenemedi: ${error.message}`, 'error');
            } finally {
                submitBtn.disabled = false;
                submitText.innerHTML = '‚ûï Ekle';
            }
        }

        function loadRecords(startDateFilter = '', endDateFilter = '', searchTerm = '') {
            if (!isFirebaseInitialized) return;
            const recordsContainer = document.getElementById('records-container');
            recordsContainer.innerHTML = `<div class="empty-state"><div class="loading"></div> Kayƒ±tlar y√ºkleniyor...</div>`;

            // T√ºm kullanƒ±cƒ±larƒ±n kayƒ±tlarƒ±nƒ± getir
            let query = db.collection('repairs').orderBy('createdAt', 'desc');

            query.onSnapshot(snapshot => {
                let allRecords = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                let filteredRecords = allRecords.filter(record => {
                    const recordDate = new Date(record.repairDate);
                    let passesDateFilter = true;
                    if (startDateFilter) {
                        if (recordDate < new Date(startDateFilter)) passesDateFilter = false;
                    }
                    if (endDateFilter) {
                        if (recordDate > new Date(endDateFilter)) passesDateFilter = false;
                    }

                    let passesSearchFilter = true;
                    if (searchTerm) {
                        const fullName = `${record.firstName || ''} ${record.lastName || ''}`.toLowerCase();
                        const phone = (record.phone || '').toLowerCase();
                        if (!fullName.includes(searchTerm) && !phone.includes(searchTerm)) {
                            passesSearchFilter = false;
                        }
                    }
                    return passesDateFilter && passesSearchFilter;
                });
                
                records = filteredRecords;
                displayRecords(records);

            }, error => {
                console.error("Kayƒ±tlarƒ± y√ºklerken hata:", error);
                showMessage(`Kayƒ±tlar y√ºklenemedi: ${error.message}`, 'error');
                recordsContainer.innerHTML = `<div class="empty-state">‚ö†Ô∏è Kayƒ±tlar y√ºklenemedi.</div>`;
            });
        }
        
        function displayRecords(recordsToDisplay) {
            const recordsContainer = document.getElementById('records-container');
            recordsContainer.innerHTML = ''; 

            if (recordsToDisplay.length === 0) {
                recordsContainer.innerHTML = `<div class="empty-state">üîç Kayƒ±t bulunamadƒ±.</div>`;
                return;
            }

            recordsToDisplay.forEach(record => {
                const card = createRecordCard(record);
                recordsContainer.appendChild(card);
            });
        }

        function createRecordCard(record) {
            const card = document.createElement('div');
            card.className = 'record-card';
            if (record.status === 'completed') {
                card.classList.add('completed-record');
            }
            card.addEventListener('click', (event) => toggleRecordDetails(card, event));
            
            const arrivalDate = record.repairDate ? new Date(record.repairDate).toLocaleDateString('tr-TR') : 'Belirtilmemi≈ü';
            
            // Kaydƒ± olu≈üturan kullanƒ±cƒ±yƒ± g√∂ster
            const creatorEmail = record.createdBy ? record.createdBy.email : 'Bilinmiyor';
            
            card.innerHTML = `
                <div class="record-header">
                    <span class="record-name">${record.firstName || ''} ${record.lastName || ''}</span>
                    <span class="expand-icon">‚ñº</span>
                </div>
                <div class="record-details-always-visible">
                     <div class="record-detail">
                        <div class="record-detail-icon">üìû</div>
                        <div class="record-detail-text">
                            <span class="record-detail-label">Telefon</span>
                            <span class="record-detail-value">${record.phone || '-'}</span>
                        </div>
                    </div>
                     <div class="record-detail">
                        <div class="record-detail-icon">üì¶</div>
                        <div class="record-detail-text">
                            <span class="record-detail-label">Adet</span>
                            <span class="record-detail-value">${record.quantity || '-'}</span>
                        </div>
                    </div>
                </div>
                <div class="record-collapsible-content">
                    <!-- Detaylar buraya eklenebilir -->
                    <p><strong>Geli≈ü Tarihi:</strong> ${arrivalDate}</p>
                    <p><strong>Notlar:</strong> ${record.notes || 'Yok'}</p>
                    ${record.photoURL ? `<img src="${record.photoURL}" class="photo-preview" style="display:block; cursor:pointer;" onclick="openPhotoModal('${record.photoURL}', event)">` : ''}
                    <div class="creator-info">Kaydƒ± olu≈üturan: ${creatorEmail}</div>
                     <div class="record-actions">
                        <button class="delete-btn" onclick="confirmDeleteRecord('${record.id}', event)">Sil</button>
                    </div>
                </div>
            `;
            return card;
        }
        
        async function deleteRecord(recordId) {
            if (!isFirebaseInitialized) return;
            try {
                await db.collection('repairs').doc(recordId).delete();
                showMessage('Kayƒ±t ba≈üarƒ±yla silindi!', 'success');
                // Liste onSnapshot sayesinde otomatik g√ºncellenecek
            } catch (error) {
                console.error("Kayƒ±t silinirken hata:", error);
                showMessage(`Kayƒ±t silinemedi: ${error.message}`, 'error');
            }
        }
        
        function confirmDeleteRecord(recordId, event) {
            event.stopPropagation();
            if (confirm("Bu kaydƒ± silmek istediƒüinizden emin misiniz? Bu i≈ülem geri alƒ±namaz.")) {
                deleteRecord(recordId);
            }
        }

        // --- Yardƒ±mcƒ± Fonksiyonlar (Deƒüi≈üiklik yok) ---
        function showMessage(message, type = 'success', duration = 4000) {
            const messageDiv = document.createElement('div');
            messageDiv.className = type === 'success' ? 'success-message' : 'error-message';
            messageDiv.textContent = message;
            document.body.appendChild(messageDiv);
            setTimeout(() => {
                messageDiv.style.top = '20px';
                messageDiv.style.opacity = '1';
            }, 10);
            setTimeout(() => {
                messageDiv.style.opacity = '0';
                messageDiv.style.top = '-100px';
                setTimeout(() => messageDiv.remove(), 500);
            }, duration);
        }

        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(section => section.classList.remove('active'));
            document.getElementById(sectionId + '-section').classList.add('active');
            if (sectionId === 'list') {
                applyFilters();
            }
        }

        function handlePhotoInputChange(event) {
            const file = event.target.files[0];
            if (file) {
                currentPhotoFile = file;
                const reader = new FileReader();
                reader.onload = e => {
                    const previewImg = document.getElementById('photo-preview-img');
                    previewImg.src = e.target.result;
                    previewImg.style.display = 'block';
                    document.getElementById('photo-placeholder').style.display = 'none';
                }
                reader.readAsDataURL(file);
            }
        }

        async function uploadPhotoToImgur(file) {
            const formData = new FormData();
            formData.append('image', file);
            const response = await fetch('https://api.imgur.com/3/image', {
                method: 'POST',
                headers: { 'Authorization': `Client-ID ${IMGUR_CLIENT_ID}` },
                body: formData
            });
            if (!response.ok) throw new Error('Imgur y√ºkleme hatasƒ±');
            const data = await response.json();
            return data.data.link;
        }

        function openPhotoModal(imageURL, event) {
            event.stopPropagation();
            if (imageURL) {
                document.getElementById('modal-image').src = imageURL;
                document.getElementById('photo-modal').style.display = 'flex';
            }
        }

        function closePhotoModal() {
            document.getElementById('photo-modal').style.display = 'none';
        }

        function toggleRecordDetails(cardElement, event) {
             if (event.target.closest('a, button, img')) return;
            cardElement.classList.toggle('expanded');
        }

        function toggleFilterControls() {
            document.querySelector('.filter-header').classList.toggle('expanded');
            document.getElementById('filter-collapsible-content').classList.toggle('expanded');
        }

        function applyFilters() {
            const startDate = document.getElementById('startDateFilter').value;
            const endDate = document.getElementById('endDateFilter').value;
            const searchTerm = document.getElementById('searchFilter').value.toLowerCase().trim();
            loadRecords(startDate, endDate, searchTerm);
        }

    </script>
</body>
</html>
