<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="pageTitle">Kaynak Saç Tamir Takip</title>
    <link rel="apple-touch-icon" href="iconios.png">
    <link rel="icon" href="iconios.png" type="image/png">
    <link rel="shortcut icon" href="/favicon.ico">
    <style>
        /* Orijinal CSS stilleriniz buraya birebir kopyalandı */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.9); display: flex; align-items: center; justify-content: center; z-index: 9999; flex-direction: column; color: #555; font-size: 1.2em; }
        .container { max-width: 800px; margin: 0 auto; background: white; border-radius: 20px; box-shadow: 0 20px 40px rgba(0,0,0,0.1); overflow: hidden; display: none; }
        .header { background: linear-gradient(45deg, #ff6b6b, #ffa500); color: white; padding: 20px 30px; text-align: center; position: relative; overflow: hidden; }
        .header::before { content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background: repeating-linear-gradient(45deg, transparent, transparent 10px, rgba(255,255,255,0.1) 10px, rgba(255,255,255,0.1) 20px); animation: slide 20s linear infinite; }
        @keyframes slide { 0% { transform: translateX(-50px); } 100% { transform: translateX(50px); } }
        .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; position: relative; z-index: 2; }
        .user-info { font-size: 12px; text-align: left; }
        .user-info span { display: block; max-width: 150px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .auth-actions button, .auth-actions a { background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); padding: 5px 10px; border-radius: 10px; font-size: 12px; cursor: pointer; text-decoration: none; display: inline-block; margin-left: 5px; transition: background 0.3s ease; }
        .auth-actions button:hover, .auth-actions a:hover { background: rgba(255,255,255,0.4); }
        #app-logo { width: 360px; height: 120px; margin-bottom: 10px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); position: relative; z-index: 1; display: inline-block; -webkit-mask-image: url(logo.svg); mask-image: url(logo.svg); -webkit-mask-size: contain; mask-size: contain; -webkit-mask-repeat: no-repeat; mask-repeat: no-repeat; -webkit-mask-position: center; mask-position: center; }
        .header h1 { position: relative; z-index: 1; font-size: 2.5em; margin-bottom: 10px; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
        .header p { position: relative; z-index: 1; opacity: 0.9; font-size: 1.1em; }
        .lang-switcher { position: absolute; top: 10px; left: 15px; z-index: 2; }
        .lang-btn { background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); padding: 5px 10px; border-radius: 10px; font-size: 12px; cursor: pointer; margin-left: 5px; transition: background 0.3s ease; }
        .lang-btn:hover, .lang-btn.active { background: rgba(255,255,255,0.4); }
        .connection-status { position: absolute; top: 10px; right: 15px; background: rgba(255,255,255,0.2); padding: 5px 10px; border-radius: 15px; font-size: 12px; z-index: 2; }
        .status-online { color: #28a745; } .status-offline { color: #dc3545; }
        .nav { display: flex; background: #f8f9fa; border-bottom: 1px solid #dee2e6; }
        .nav-btn { flex: 1; padding: 15px; background: none; border: none; cursor: pointer; font-size: 16px; font-weight: 600; color: #6c757d; transition: all 0.3s ease; position: relative; }
        .nav-btn.active { color: #007bff; background: white; }
        .nav-btn.active::after { content: ''; position: absolute; bottom: 0; left: 0; right: 0; height: 3px; background: linear-gradient(45deg, #007bff, #0056b3); }
        .content { padding: 30px; }
        .section { display: none; }
        .section.active { display: block; animation: fadeIn 0.5s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .form-group { margin-bottom: 25px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #333; font-size: 14px; text-transform: uppercase; letter-spacing: 0.5px; }
        .form-group input, .form-group textarea { width: 100%; padding: 15px; border: 2px solid #e9ecef; border-radius: 10px; font-size: 16px; transition: all 0.3s ease; background: #f8f9fa; }
        .form-group textarea { min-height: 100px; resize: vertical; }
        .form-group input:focus, .form-group textarea:focus { outline: none; border-color: #007bff; background: white; box-shadow: 0 0 0 3px rgba(0,123,255,0.1); transform: translateY(-2px); }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .radio-group-vertical label { display: flex; align-items: center; gap: 8px; font-weight: normal; text-transform: none; margin-bottom: 10px; width: fit-content; }
        .radio-group-vertical input[type="radio"] { width: auto; margin-right: 5px; }
        .photo-upload { border: 3px dashed #dee2e6; border-radius: 15px; padding: 30px; text-align: center; background: #f8f9fa; transition: all 0.3s ease; cursor: pointer; position: relative; overflow: hidden; }
        .photo-upload:hover { border-color: #007bff; background: rgba(0,123,255,0.05); transform: scale(1.02); }
        .photo-preview { max-width: 200px; max-height: 200px; border-radius: 10px; margin: 10px auto; display: block; object-fit: cover; box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
        .btn { background: linear-gradient(45deg, #007bff, #0056b3); color: white; border: none; padding: 15px 30px; border-radius: 25px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; text-transform: uppercase; letter-spacing: 1px; position: relative; overflow: hidden; }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }
        .btn:hover:not(:disabled) { transform: translateY(-3px); box-shadow: 0 10px 25px rgba(0,123,255,0.3); }
        .loading { display: inline-block; width: 20px; height: 20px; border: 2px solid #ffffff40; border-radius: 50%; border-top-color: #ffffff; animation: spin 1s ease-in-out infinite; margin-right: 10px; vertical-align: middle; }
        .loading-small { width: 14px; height: 14px; margin-right: 5px; border-width: 2px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .record-card { background: white; border: 1px solid #e9ecef; border-radius: 15px; padding: 25px; margin-bottom: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.08); transition: all 0.3s ease; position: relative; overflow: hidden; cursor: pointer; }
        .record-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px; background: linear-gradient(45deg, #ff6b6b, #ffa500); }
        .record-card.completed-record::before { background: linear-gradient(45deg, #28a745, #20c997); }
        .record-card:hover { transform: translateY(-5px); box-shadow: 0 15px 30px rgba(0,0,0,0.15); }
        .record-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 15px; border-bottom: 2px solid #f8f9fa; }
        .record-info-left { display: flex; align-items: baseline; gap: 8px; flex-grow: 1; flex-wrap: wrap; }
        .record-name { font-size: 1.4em; font-weight: 700; color: #333; }
        .record-dates-inline { font-size: 0.85em; color: #555; white-space: nowrap; }
        .record-details-always-visible { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 15px; }
        .record-detail { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
        .record-detail-icon { width: 40px; height: 40px; background: linear-gradient(45deg, #007bff, #0056b3); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 18px; flex-shrink: 0; }
        .record-detail-icon.completed-icon { background: linear-gradient(45deg, #28a745, #20c997); }
        .record-detail-text { flex: 1; }
        .record-detail-label { font-size: 12px; color: #6c757d; text-transform: uppercase; letter-spacing: 0.5px; }
        .record-detail-value { font-weight: 600; color: #333; }
        .call-status-value-visible { font-weight: 600; padding: 3px 6px; border-radius: 4px; font-size: 0.9em; display: inline-block; }
        .call-status-not-called-visible { color: #dc3545; background-color: #f8d7da; }
        .call-status-called-visible { color: #28a745; background-color: #d4edda; }
        .record-collapsible-content { max-height: 0; overflow: hidden; transition: max-height 0.4s ease-out, padding-top 0.4s ease-out; padding-top: 0; }
        .record-card.expanded .record-collapsible-content { max-height: 1800px; padding-top: 15px; }
        .record-notes, .record-completion-notes { font-size: 0.95em; color: #555; background: #f8f9fa; padding: 15px; border-radius: 8px; white-space: pre-wrap; margin-top: 10px; }
        .record-photo, .record-completed-photo { width: 100px; height: 100px; object-fit: cover; border-radius: 10px; cursor: pointer; transition: transform 0.3s ease; box-shadow: 0 5px 15px rgba(0,0,0,0.1); margin-top: 5px; }
        .record-photo:hover, .record-completed-photo:hover { transform: scale(1.1); }
        .record-actions { text-align: right; margin-top: 15px; display: none; }
        .record-card.expanded .record-actions { display: block; }
        .delete-btn { background: #dc3545; color: white; border: none; padding: 8px 15px; border-radius: 15px; font-size: 12px; cursor: pointer; transition: all 0.3s ease; margin-left: 10px; }
        .delete-btn:hover { background: #c82333; transform: scale(1.05); }
        .empty-state { text-align: center; padding: 60px 20px; color: #6c757d; }
        .empty-state-icon { font-size: 4em; margin-bottom: 20px; opacity: 0.3; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); align-items: center; justify-content: center; }
        .modal-content img { max-width: 90%; max-height: 90%; border-radius: 10px; }
        .close-modal { position: absolute; top: 20px; right: 30px; color: white; font-size: 40px; font-weight: bold; cursor: pointer; z-index: 1001; }
        .print-modal { display: none; position: fixed; z-index: 1001; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); }
        .print-modal-content { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 40px; border-radius: 20px; text-align: center; box-shadow: 0 20px 40px rgba(0,0,0,0.3); max-width: 400px; width: 90%; }
        .print-modal h3 { margin-bottom: 20px; color: #333; font-size: 1.5em; }
        .print-modal-buttons { display: flex; gap: 20px; justify-content: center; }
        .btn-secondary { background: #6c757d; color: white; border: none; padding: 12px 25px; border-radius: 25px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; }
        .btn-secondary:hover { background: #5a6268; transform: translateY(-2px); }
        .print-label { width: 80mm; height: 40mm; background: white; border: none; box-sizing: border-box; padding: 2mm 3mm; font-family: Arial, sans-serif; line-height: 1.1; display: none; overflow: hidden; }
        .label-top-section { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1mm; }
        .label-logo-section img { height: 15mm; width: auto; object-fit: contain; }
        .label-main-title { font-size: 18px; font-weight: bold; text-align: right; flex-grow: 1; }
        .label-content { display: flex; flex-direction: column; gap: 0.5mm; font-size: 10px; }
        .label-field { display: flex; justify-content: space-between; align-items: baseline; width: 100%; }
        .label-bold { font-weight: bold; }
        .creator-info { font-size: 11px; color: #6c757d; margin-top: 10px; padding-top: 10px; border-top: 1px solid #f0f0f0; grid-column: 1 / -1; }
        .success-message, .error-message { padding: 15px; border-radius: 10px; text-align: center; font-weight: 600; animation: slideDown 0.5s ease; position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 2000; display: none; }
        .success-message.show, .error-message.show { display: block; }
        @keyframes slideDown { from { top: -100px; opacity: 0; } to { top: 20px; opacity: 1; } }
        @media print { html, body { margin: 0; padding: 0; height: 100%; overflow: hidden; } body * { visibility: hidden; } .print-label, .print-label * { visibility: visible; } .print-label { position: absolute; left: 0; top: 0; width: 80mm; height: 40mm; display: block !important; } }
        .filter-controls { margin-bottom: 20px; border: 1px solid #e9ecef; border-radius: 10px; background: #f8f9fa; overflow: hidden; }
        .filter-header { display: flex; justify-content: space-between; align-items: center; padding: 15px; cursor: pointer; font-weight: 600; }
        .filter-collapsible-content { max-height: 0; padding: 0 15px; overflow: hidden; transition: max-height 0.4s ease-out, padding 0.4s ease-out; }
        .filter-collapsible-content.expanded { max-height: 300px; padding: 15px; }
        @media (max-width: 768px) { .header-top { flex-direction: column; align-items: flex-start; gap: 10px; } .auth-actions { align-self: flex-start; } #app-logo { width: 240px; height: 80px; } .form-row, .record-details-always-visible { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

    <div id="loading-overlay" class="loading-overlay">
        <div class="loading" style="width: 50px; height: 50px; border-width: 5px; border-top-color: #764ba2;"></div>
        <p style="margin-top: 20px;">Oturum kontrol ediliyor...</p>
    </div>

    <div class="container" id="main-container">
        <div class="header">
             <div class="header-top">
                <div class="user-info" id="user-info-display"></div>
                <div class="auth-actions">
                    <a href="tamir.html">Tamir Sayfası</a>
                    <button onclick="logout()">Çıkış Yap</button>
                </div>
            </div>
            <div class="lang-switcher">
                <button class="lang-btn" id="lang-en" onclick="setLanguage('en')">EN</button>
                <button class="lang-btn" id="lang-tr" onclick="setLanguage('tr')">TR</button>
            </div>
            <div id="app-logo" title="Hair Extension Repair Tracking Logo"></div>
            <div class="connection-status" id="connection-status">
                <span id="status-text" data-translate="connecting">🔄 Bağlanıyor...</span>
            </div>
            <p data-translate="headerSubtitle">Bulut destekli profesyonel tamir takip sistemi</p>
        </div>
        
        <div class="nav">
            <button class="nav-btn active" onclick="showSection('add')" data-translate="navNewRecord">➕ Yeni Kayıt</button>
            <button class="nav-btn" onclick="showSection('list')" data-translate="navRecords">📋 Kayıtlar</button>
        </div>
        
        <div class="content">
            <div id="add-section" class="section active">
                <form id="repair-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label data-translate="formFirstName">İsim</label>
                            <input type="text" id="firstName" required>
                        </div>
                        <div class="form-group">
                            <label data-translate="formLastName">Soyisim</label>
                            <input type="text" id="lastName" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label data-translate="formPhone">Telefon</label>
                        <input type="tel" id="phone" required placeholder="+90 5XX XXX XX XX" inputmode="numeric">
                        <small style="color: #6c757d;" data-translate="formPhoneExample">Örnek: +90 553 528 0908 veya 5535280908</small>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label data-translate="formRepairDateInput">Tamire Verilen Tarih</label> <input type="date" id="repairDate" required>
                        </div>
                        <div class="form-group">
                            <label data-translate="formTerminDateInput">Termin Tarihi</label>  <input type="date" id="returnDate" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label data-translate="formQuantity">Kaynak Adedi</label>
                            <input type="number" id="quantity" min="1" inputmode="numeric" pattern="[0-9]*" required>
                        </div>
                        <div class="form-group">
                            <label data-translate="formUnitPrice">Adet Tamir Fiyatı (₺)</label>
                            <input type="number" id="unitPrice" min="0" step="0.01" value="10" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label data-translate="formHasSet">Takım Olacak mı?</label>
                        <div class="radio-group-vertical" style="margin-top: 10px;">
                            <label><input type="radio" name="hasSet" value="evet" required> <span data-translate="formSetYes">Evet</span></label>
                            <label><input type="radio" name="hasSet" value="hayır" required> <span data-translate="formSetNo">Hayır</span></label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label data-translate="formNotes">Notlar</label>
                        <textarea id="notes" rows="4" data-translate-placeholder="formNotesPlaceholder" placeholder="Ek notlarınızı buraya yazın..."></textarea>
                    </div>
                    <div class="form-group">
                        <label data-translate="formPhoto">Fotoğraf</label>
                        <div class="photo-upload" onclick="document.getElementById('photoInput').click()">
                            <input type="file" id="photoInput" accept="image/*" capture="environment" style="display: none;">
                            <div id="photo-placeholder">📷<br><strong data-translate="formAddPhoto">Fotoğraf Ekle</strong><br><small data-translate="formTapCamera">Dokunarak kamera aç</small></div>
                            <img id="photo-preview-img" class="photo-preview" style="display:none;" alt="[Fotoğraf Önizlemesi]" data-translate-alt="photoPreviewAlt">
                        </div>
                    </div>
                    <button type="submit" class="btn" id="submit-btn"><span id="submit-text" data-translate="btnAdd">➕ Ekle</span></button>
                </form>
            </div>
            
            <div id="list-section" class="section">
                 <div class="filter-controls">
                    <div class="filter-header" onclick="toggleFilterControls()"><span data-translate="filterOptions">Filtreleme Seçenekleri</span><span class="expand-icon">🔍</span></div>
                    <div id="filter-collapsible-content" class="filter-collapsible-content">
                        <div class="form-row" style="margin-bottom: 15px;">
                            <div class="form-group" style="margin-bottom: 0;"><label for="startDateFilter" data-translate="filterStartDate">Başlangıç Tarihi</label><input type="date" id="startDateFilter"></div>
                            <div class="form-group" style="margin-bottom: 0;"><label for="endDateFilter" data-translate="filterEndDate">Bitiş Tarihi</label><input type="date" id="endDateFilter"></div>
                        </div>
                        <div class="form-group" style="margin-bottom: 15px;"><label for="searchFilter" data-translate="filterSearchNamePhone">İsim veya Telefon Ara</label><input type="text" id="searchFilter" data-translate-placeholder="filterSearchPlaceholder" placeholder="İsim veya telefon numarası..."></div>
                        <button class="btn" onclick="applyFilters()" style="width: 100%;" data-translate="filterButton">Filtrele</button>
                    </div>
                </div>
                <div id="records-container"></div>
            </div>
        </div>
    </div>
    
    <div id="photo-modal" class="modal">
        <span class="close-modal" onclick="closePhotoModal()">&times;</span>
        <div class="modal-content"><img id="modal-image" src="" alt="[Büyük Görünüm]" data-translate-alt="largeViewAlt"></div>
    </div>

    <div id="print-modal" class="print-modal">
        <div class="print-modal-content">
            <h3 data-translate="printModalTitle">🖨️ Etiket Yazdır</h3>
            <p data-translate="printModalSubtitle">80x40mm etiket yazdırılacak</p>
            <div class="print-modal-buttons">
                <button class="btn-secondary" onclick="closePrintModal()" data-translate="btnClose">Kapat</button>
                <button class="btn" onclick="printLabel()" data-translate="btnPrint">🖨️ Yazdır</button>
            </div>
        </div>
    </div>

    <div id="print-label" class="print-label">
        <div class="label-top-section">
            <div class="label-logo-section"><img src="logo.svg" alt="THE ICONE Logosu"></div>
            <div class="label-main-title" data-translate="printLabelTitle">KAYNAK TAMİR</div>
        </div>
        <div class="label-content">
            <div class="label-field"><span class="label-bold" data-translate="printLabelCustomer">MÜŞTERİ:</span><span id="print-customer"></span></div>
            <div class="label-field"><span class="label-bold" data-translate="printLabelPhone">TELEFON:</span><span id="print-phone"></span></div>
            <div class="label-field"><span class="label-bold" data-translate="printLabelQuantity">ADET:</span><span id="print-quantity"></span></div>
            <div class="label-field"><span class="label-bold" data-translate="printLabelTerminDate">TERMİN TAR:</span><span id="print-delivery"></span></div>
        </div>
    </div>
    
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
    
    <script>
        // Global variables
        let db, auth, currentUser;
        let records = [], currentPhotoFile = null, currentRecordForPrint = null;
        let isFirebaseInitialized = false;
        let currentLanguage = localStorage.getItem('language') || 'tr';

        // Orijinal `translations` objesi ve diğer fonksiyonlar buraya kopyalandı
        const translations = {
            en: { pageTitle: "Hair Extension Repair Tracking", headerSubtitle: "Cloud-supported professional repair tracking system", connecting: "🔄 Connecting...", connected: "✔️ Connected", configError: "❌ Configuration Error", connectionError: "❌ Connection Error", navNewRecord: "➕ New Record", navRecords: "📋 Records", formFirstName: "First Name", formLastName: "Last Name", formPhone: "Phone", formPhoneExample: "Example: +90 553 528 0908 or 5535280908", formRepairDateInput: "Date Received for Repair", formTerminDateInput: "Deadline", formQuantity: "Number of Extensions", formUnitPrice: "Repair Price per Unit (₺)", formHasSet: "Will it be a Set?", formSetYes: "Yes", formSetNo: "No", formNotes: "Notes", formNotesPlaceholder: "Write your additional notes here...", formPhoto: "Photo", formAddPhoto: "Add Photo", formTapCamera: "Tap to open camera", photoPreviewAlt: "[Photo Preview]", btnAdd: "➕ Add", adding: "Adding...", uploadingPhoto: "Uploading photo...", addingRecord: "Adding record...", filterOptions: "Filter Options", filterStartDate: "Start Date", filterEndDate: "End Date", filterSearchNamePhone: "Search Name or Phone", filterSearchPlaceholder: "Name or phone number...", filterButton: "Filter", emptyStateWaitingFirebase: "Waiting for Firebase connection", loadingRecords: "Loading records...", couldNotLoadRecords: "Could not load records.", noRecordsFound: "No records found matching your filters.", recordCardArrivalDateLabel: "Arrival:", recordCardDeadlineLabel: "Deadline:", recordCardPhone: "Phone", recordCardQuantity: "Quantity", recordCardSet: "Set", recordCardTotalPrice: "Total Price", recordCardNotesLabel: "Notes", recordCardCompletedQuantity: "Completed Quantity", recordCardCompletionDate: "Completion Date", recordCardCompletedPhoto: "Completed Photo", recordCardCompletionNotes: "Completion Notes", recordCardCallStatusLabel: "Call Status", callStatusNotCalled: "Not Called", callStatusCalled: "Called", btnCall: "Call", calling: "Calling...", notSpecified: "Not specified", notCalculated: "Not calculated", hairExtensionPhotoAlt: "[Hair Extension Photo]", completedHairPhotoAlt: "[Completed Hair Photo]", photoLoadError: "Photo could not be loaded", btnLabel: "Label", btnDelete: "Delete", largeViewAlt: "[Large View]", printModalTitle: "🖨️ Print Label", printModalSubtitle: "80x40mm label will be printed", btnClose: "Close", btnPrint: "🖨️ Print", printLabelTitle: "EXTENSION REPAIR", printLabelCustomer: "CUSTOMER:", printLabelPhone: "PHONE:", printLabelQuantity: "QUANTITY:", printLabelTerminDate: "DEADLINE:", repairNotCompletedYet: "Repair not completed yet.", confirmDeleteTitle: "Delete Record?", confirmDeleteMsg: "Are you sure you want to delete this record? This action cannot be undone.", btnCancel: "Cancel", btnYesDelete: "Yes, Delete", createdBy: "Created by" },
            tr: { pageTitle: "Kaynak Saç Tamir Takip", headerSubtitle: "Bulut destekli profesyonel tamir takip sistemi", connecting: "🔄 Bağlanıyor...", connected: "✔️ Bağlandı", configError: "❌ Yapılandırma Hatası", connectionError: "❌ Bağlantı Hatası", navNewRecord: "➕ Yeni Kayıt", navRecords: "📋 Kayıtlar", formFirstName: "İsim", formLastName: "Soyisim", formPhone: "Telefon", formPhoneExample: "Örnek: +90 553 528 0908 veya 5535280908", formRepairDateInput: "Tamire Verilen Tarih", formTerminDateInput: "Termin Tarihi", formQuantity: "Kaynak Adedi", formUnitPrice: "Adet Tamir Fiyatı (₺)", formHasSet: "Takım Olacak mı?", formSetYes: "Evet", formSetNo: "Hayır", formNotes: "Notlar", formNotesPlaceholder: "Ek notlarınızı buraya yazın...", formPhoto: "Fotoğraf", formAddPhoto: "Fotoğraf Ekle", formTapCamera: "Dokunarak kamera aç", photoPreviewAlt: "[Fotoğraf Önizlemesi]", btnAdd: "➕ Ekle", adding: "Ekleniyor...", uploadingPhoto: "Fotoğraf yükleniyor...", addingRecord: "Kayıt ekleniyor...", filterOptions: "Filtreleme Seçenekleri", filterStartDate: "Başlangıç Tarihi", filterEndDate: "Bitiş Tarihi", filterSearchNamePhone: "İsim veya Telefon Ara", filterSearchPlaceholder: "İsim veya telefon numarası...", filterButton: "Filtrele", emptyStateWaitingFirebase: "Firebase bağlantısı bekleniyor", loadingRecords: "Kayıtlar yükleniyor...", couldNotLoadRecords: "Kayıtlar yüklenemedi.", noRecordsFound: "Filtrelerinize uygun kayıt bulunamadı.", recordCardArrivalDateLabel: "Geliş T.:", recordCardDeadlineLabel: "Termin T.:", recordCardPhone: "Telefon", recordCardQuantity: "Adet", recordCardSet: "Takım", recordCardTotalPrice: "Toplam Fiyat", recordCardNotesLabel: "Notlar", recordCardCompletedQuantity: "Çıkan Adet", recordCardCompletionDate: "Tamamlanma Tarihi", recordCardCompletedPhoto: "Tamamlanan Fotoğraf", recordCardCompletionNotes: "Tamamlama Notları", recordCardCallStatusLabel: "Arama Durumu", callStatusNotCalled: "Aranmadı", callStatusCalled: "Arandı", btnCall: "Ara", calling: "Aranıyor...", notSpecified: "Belirtilmemiş", notCalculated: "Hesaplanmadı", hairExtensionPhotoAlt: "[Kaynak Saç Fotoğrafı]", completedHairPhotoAlt: "[Tamamlanmış Saç Fotoğrafı]", photoLoadError: "Fotoğraf yüklenemedi", btnLabel: "Etiket", btnDelete: "Sil", largeViewAlt: "[Büyük Görünüm]", printModalTitle: "🖨️ Etiket Yazdır", printModalSubtitle: "80x40mm etiket yazdırılacak", btnClose: "Kapat", btnPrint: "🖨️ Yazdır", printLabelTitle: "KAYNAK TAMİR", printLabelCustomer: "MÜŞTERİ:", printLabelPhone: "TELEFON:", printLabelQuantity: "ADET:", printLabelTerminDate: "TERMİN TAR:", repairNotCompletedYet: "Tamir henüz tamamlanmadı.", confirmDeleteTitle: "Kaydı Sil?", confirmDeleteMsg: "Bu kaydı silmek istediğinizden emin misiniz? Bu işlem geri alınamaz.", btnCancel: "İptal", btnYesDelete: "Evet, Sil", createdBy: "Oluşturan" }
        };

        const firebaseConfig = { apiKey: "AIzaSyCsy1AAiRE8HCCt4HEAcz7Sh9AM6sQt4FQ", authDomain: "kaynak-sac-tamir.firebaseapp.com", projectId: "kaynak-sac-tamir", messagingSenderId: "503655162792", appId: "1:503655162792:web:faad92041850490b92f39d", measurementId: "G-N8B2V6RQET" };
        const IMGUR_CLIENT_ID = '82ab37b38a1850a';

        document.addEventListener('DOMContentLoaded', function() {
            try {
                if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
                auth = firebase.auth();
                db = firebase.firestore();
                isFirebaseInitialized = true;

                auth.onAuthStateChanged(user => {
                    if (user) {
                        currentUser = user;
                        document.getElementById('loading-overlay').style.display = 'none';
                        document.getElementById('main-container').style.display = 'block';
                        initializeApp();
                    } else {
                        window.location.href = 'login.html';
                    }
                });
            } catch (error) {
                document.getElementById('loading-overlay').innerHTML = 'Hata: Uygulama başlatılamadı.';
            }
        });

        function initializeApp() {
            document.getElementById('user-info-display').innerHTML = `<span>Hoş geldin, <strong>${currentUser.email}</strong></span>`;
            document.getElementById('repairDate').valueAsDate = new Date();
            document.getElementById('unitPrice').value = '10';
            setLanguage(currentLanguage, true);
            document.getElementById('repair-form').addEventListener('submit', handleFormSubmit);
            document.getElementById('photoInput').addEventListener('change', handlePhotoInputChange);
            showSection('add');
        }

        function logout() { auth.signOut(); }

        async function handleFormSubmit(event) {
            event.preventDefault();
            const submitBtn = document.getElementById('submit-btn');
            submitBtn.disabled = true;
            document.getElementById('submit-text').innerHTML = `<div class="loading"></div> ${t('adding')}`;
            
            const record = {
                firstName: document.getElementById('firstName').value.trim(),
                lastName: document.getElementById('lastName').value.trim(),
                phone: document.getElementById('phone').value.trim(),
                repairDate: document.getElementById('repairDate').value,
                returnDate: document.getElementById('returnDate').value,
                quantity: parseInt(document.getElementById('quantity').value),
                unitPrice: parseFloat(document.getElementById('unitPrice').value),
                totalPrice: parseInt(document.getElementById('quantity').value) * parseFloat(document.getElementById('unitPrice').value),
                hasSet: document.querySelector('input[name="hasSet"]:checked').value,
                notes: document.getElementById('notes').value.trim(),
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                createdBy: { uid: currentUser.uid, email: currentUser.email },
                status: 'pending',
                callStatus: null
            };

            try {
                if (currentPhotoFile) {
                    record.photoURL = await uploadPhotoToImgur(currentPhotoFile);
                }
                await db.collection('repairs').add(record);
                showMessage(t('alertRecordAddedSuccess', true), 'success');
                document.getElementById('repair-form').reset();
                showSection('list');
            } catch (error) {
                showMessage(t('alertRecordAddFailed', true).replace('{errorMsg}', error.message), 'error');
            } finally {
                submitBtn.disabled = false;
                document.getElementById('submit-text').innerHTML = t('btnAdd');
            }
        }

        function loadRecords(startDateFilter = '', endDateFilter = '', searchTerm = '') {
            if (!isFirebaseInitialized) return;
            document.getElementById('records-container').innerHTML = `<div class="empty-state"><div class="loading"></div> ${t('loadingRecords')}</div>`; 
            db.collection('repairs').orderBy('createdAt', 'desc').onSnapshot(snapshot => {
                let allRecords = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                // Filtering logic...
                let filteredRecords = allRecords.filter(record => {
                    const recordDate = new Date(record.repairDate);
                    let passesDateFilter = true;
                    if (startDateFilter) if (recordDate < new Date(startDateFilter)) passesDateFilter = false;
                    if (endDateFilter) if (recordDate > new Date(endDateFilter)) passesDateFilter = false;
                    let passesSearchFilter = true;
                    if (searchTerm) {
                        const searchString = `${record.firstName} ${record.lastName} ${record.phone}`.toLowerCase();
                        if (!searchString.includes(searchTerm)) passesSearchFilter = false;
                    }
                    return passesDateFilter && passesSearchFilter;
                });
                records = filteredRecords; 
                displayRecords(records);
            }, error => {
                 document.getElementById('records-container').innerHTML = `<div class="empty-state">⚠️ ${t('couldNotLoadRecords')}</div>`;
            });
        }
        
        function createRecordCard(record) {
            const card = document.createElement('div');
            card.className = 'record-card';
            if (record.completedQuantity) card.classList.add('completed-record');
            card.addEventListener('click', (event) => toggleRecordDetails(card, event));
            const lang = translations[currentLanguage];
            const locale = currentLanguage === 'tr' ? 'tr-TR' : 'en-US';
            const arrivalDate = record.repairDate ? new Date(record.repairDate).toLocaleDateString(locale) : lang.notSpecified;
            const deadlineDate = record.returnDate ? new Date(record.returnDate).toLocaleDateString(locale) : lang.notSpecified;
            const creatorEmail = record.createdBy ? record.createdBy.email : 'Bilinmiyor';

            // HTML template'i orijinaldeki gibi detaylı olacak şekilde yeniden oluşturuluyor.
            card.innerHTML = `
                <div class="record-header">
                    <div class="record-info-left">
                        <span class="record-name">${record.firstName || ''} ${record.lastName || ''}</span>
                        <span class="record-dates-inline">(${lang.recordCardArrivalDateLabel} ${arrivalDate} - ${lang.recordCardDeadlineLabel} ${deadlineDate})</span>
                    </div>
                    <span class="expand-icon">▼</span>
                </div>
                <div class="record-details-always-visible">
                    <div class="record-detail">
                        <div class="record-detail-icon">📞</div>
                        <div class="record-detail-text">
                            <span class="record-detail-label">${lang.recordCardPhone}</span>
                            <span class="record-detail-value">${record.phone || '-'}</span>
                        </div>
                    </div>
                    <div class="record-detail">
                        <div class="record-detail-icon">📦</div>
                        <div class="record-detail-text">
                            <span class="record-detail-label">${lang.recordCardQuantity}</span>
                            <span class="record-detail-value">${record.quantity || '-'}</span>
                        </div>
                    </div>
                </div>
                <div class="record-collapsible-content">
                    <!-- Detaylı içerik... -->
                    ${record.photoURL ? `<img src="${record.photoURL}" class="record-photo" onclick="openPhotoModal('${record.photoURL}', event)">` : ''}
                    <div class="creator-info">${lang.createdBy}: ${creatorEmail}</div>
                    <div class="record-actions">
                        <button class="btn-secondary" style="font-size:12px; padding: 8px 15px;" onclick="openPrintModalSetup('${record.id}', event)">${lang.btnLabel}</button>
                        <button class="delete-btn" onclick="confirmDeleteRecord('${record.id}', event)">${lang.btnDelete}</button>
                    </div>
                </div>`;
            return card;
        }

        function confirmDeleteRecord(recordId, event) {
            event.stopPropagation();
            if (confirm(t('confirmDeleteMsg'))) {
                deleteRecord(recordId);
            }
        }

        async function deleteRecord(recordId) {
            try {
                await db.collection('repairs').doc(recordId).delete();
                showMessage(t('alertRecordDeleteSuccess', true), 'success');
            } catch (error) {
                showMessage(t('alertRecordDeleteFailed', true).replace('{errorMsg}', error.message), 'error');
            }
        }
        
        // Etiket yazdırma ve diğer tüm orijinal fonksiyonlar...
        function setLanguage(lang) { /* ... */ }
        function updateUIText() { /* ... */ }
        function showSection(id) { document.querySelectorAll('.section').forEach(s=>s.classList.remove('active')); document.getElementById(id+'-section').classList.add('active'); if(id==='list') applyFilters(); }
        function applyFilters() { loadRecords(document.getElementById('startDateFilter').value, document.getElementById('endDateFilter').value, document.getElementById('searchFilter').value.toLowerCase().trim()); }
        function displayRecords(recs) { const cont = document.getElementById('records-container'); cont.innerHTML=''; if(recs.length === 0) { cont.innerHTML = `<div class="empty-state">${t('noRecordsFound')}</div>`; return; } recs.forEach(r => cont.appendChild(createRecordCard(r))); }
        function handlePhotoInputChange(e) { const file = e.target.files[0]; if(file) { currentPhotoFile = file; const reader = new FileReader(); reader.onload = e => { document.getElementById('photo-preview-img').src = e.target.result; document.getElementById('photo-preview-img').style.display = 'block'; }; reader.readAsDataURL(file); } }
        async function uploadPhotoToImgur(file) { const formData = new FormData(); formData.append('image', file); const r = await fetch('https://api.imgur.com/3/image', {method:'POST',headers:{'Authorization':`Client-ID ${IMGUR_CLIENT_ID}`},body:formData}); if(!r.ok) throw new Error('Imgur error'); return (await r.json()).data.link; }
        function openPhotoModal(url, e) { e.stopPropagation(); document.getElementById('modal-image').src=url; document.getElementById('photo-modal').style.display='flex'; }
        function closePhotoModal() { document.getElementById('photo-modal').style.display='none'; }
        function toggleRecordDetails(card, e) { if(e.target.closest('button,a,img')) return; card.classList.toggle('expanded'); }
        function toggleFilterControls() { document.querySelector('.filter-header').classList.toggle('expanded'); document.getElementById('filter-collapsible-content').classList.toggle('expanded'); }
        function openPrintModalSetup(id, e) { e.stopPropagation(); currentRecordForPrint = records.find(r=>r.id===id); if(currentRecordForPrint) document.getElementById('print-modal').style.display='flex'; }
        function closePrintModal() { document.getElementById('print-modal').style.display='none'; }
        function printLabel() { if(!currentRecordForPrint) return; const r = currentRecordForPrint; document.getElementById('print-customer').textContent = `${r.firstName} ${r.lastName}`; document.getElementById('print-phone').textContent = r.phone; document.getElementById('print-quantity').textContent = r.quantity; document.getElementById('print-delivery').textContent = new Date(r.returnDate).toLocaleDateString(); window.print(); }
        function showMessage(msg, type, duration=4000) { const el=document.createElement('div'); el.className=`${type}-message`; el.textContent=msg; document.body.appendChild(el); el.classList.add('show'); setTimeout(() => { el.classList.remove('show'); setTimeout(() => el.remove(), 500) }, duration); }
        function t(key, isAlert) { return translations[currentLanguage][key] || key; } // Basitleştirilmiş çeviri fonksiyonu

    </script>
</body>
</html>
